<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Meditative AR Garden</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
    <style>
        body { 
            margin: 0; 
            font-family: Arial; 
            overflow: hidden; 
            background: #0a0a0a;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }
        
        .zen-instructions {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.5);
            color: rgba(255,255,255,0.9);
            padding: 15px 25px;
            border-radius: 25px;
            text-align: center;
            font-size: 12px;
            max-width: 60%;
            backdrop-filter: blur(5px);
            font-weight: 300;
        }
        
        /* Full-screen tap detection */
        .tap-surface {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: all;
            background: transparent;
            cursor: crosshair;
        }
        
        .progress-counter {
            position: absolute;
            top: 90px;
            right: 30px;
            background: rgba(0,0,0,0.6);
            color: rgba(255,255,255,0.8);
            padding: 8px 12px;
            border-radius: 12px;
            font-weight: 300;
            font-size: 11px;
            backdrop-filter: blur(3px);
        }
        
        /* Colored discovery pulses for each direction */
        .discovery-pulse {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            pointer-events: none;
            display: none;
            transform: translate(-50%, -50%);
        }
        
        .pulse-east {
            border: 4px solid rgba(0,255,127,0.9);
            background: radial-gradient(circle, rgba(0,255,127,0.3) 0%, rgba(0,255,127,0.1) 60%, transparent 100%);
            box-shadow: 0 0 30px rgba(0,255,127,0.6), inset 0 0 20px rgba(0,255,127,0.2);
            animation: pulseGreen 2.5s ease-out;
        }
        
        .pulse-south {
            border: 4px solid rgba(255,20,147,0.9);
            background: radial-gradient(circle, rgba(255,20,147,0.3) 0%, rgba(255,20,147,0.1) 60%, transparent 100%);
            box-shadow: 0 0 30px rgba(255,20,147,0.6), inset 0 0 20px rgba(255,20,147,0.2);
            animation: pulsePink 2.5s ease-out;
        }
        
        .pulse-west {
            border: 4px solid rgba(255,255,255,0.9);
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 60%, transparent 100%);
            box-shadow: 0 0 30px rgba(255,255,255,0.6), inset 0 0 20px rgba(255,255,255,0.2);
            animation: pulseWhite 2.5s ease-out;
        }
        
        .pulse-north {
            border: 4px solid rgba(173,216,230,0.9);
            background: radial-gradient(circle, rgba(173,216,230,0.3) 0%, rgba(173,216,230,0.1) 60%, transparent 100%);
            box-shadow: 0 0 30px rgba(173,216,230,0.6), inset 0 0 20px rgba(173,216,230,0.2);
            animation: pulseBlue 2.5s ease-out;
        }
        
        @keyframes pulseGreen {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }
        }
        
        @keyframes pulsePink {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }
        }
        
        @keyframes pulseWhite {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }
        }
        
        @keyframes pulseBlue {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }
        }
        
        .completion-message {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            color: rgba(255,255,255,0.9);
            padding: 20px 30px;
            border-radius: 25px;
            font-size: 13px;
            display: none;
            text-align: center;
            backdrop-filter: blur(5px);
            font-weight: 300;
        }
        
        .tap-hint {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.7);
            padding: 8px 16px;
            border-radius: 15px;
            font-size: 10px;
            backdrop-filter: blur(3px);
            font-weight: 300;
        }
    </style>
</head>
<body>
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false">
        <!-- Container for dynamically positioned sculptures -->
        <a-entity id="sculpture-container"></a-entity>
        
        <a-entity camera look-controls="enabled: true; pointerLockEnabled: false" wasd-controls="enabled: false"></a-entity>
    </a-scene>

    <div class="overlay">
        <div class="zen-instructions" id="instructions">
            Breathe deeply. Touch the ground to grow your garden ðŸŒ±
        </div>
        
        <div class="progress-counter" id="progress">
            Bloomed: <span id="count">0</span>/4
        </div>
        
        <div class="tap-hint" id="tapHint">
            Tap anywhere on the ground plane
        </div>
        
        <!-- Full-screen tap surface -->
        <div class="tap-surface" id="tapSurface"></div>
        
        <!-- Colored discovery pulses -->
        <div class="discovery-pulse pulse-east" id="pulseEast"></div>
        <div class="discovery-pulse pulse-south" id="pulseSouth"></div>
        <div class="discovery-pulse pulse-west" id="pulseWest"></div>
        <div class="discovery-pulse pulse-north" id="pulseNorth"></div>
        
        <div class="completion-message" id="completionMessage">
            âœ¨ Your meditation garden is complete âœ¨<br>
            <small>Breathe and observe â€¢ Shake to begin anew</small>
        </div>
    </div>

    <script>
        // Meditative garden configuration
        const artworkSequence = [
            {
                id: 'east-artwork',
                src: 'east-piece.glb',
                name: 'Eastern Serenity',
                color: 'green',
                pulseId: 'pulseEast'
            },
            {
                id: 'south-artwork',
                src: 'south-piece.glb',
                name: 'Southern Harmony',
                color: 'pink',
                pulseId: 'pulseSouth'
            },
            {
                id: 'west-artwork',
                src: 'west-piece.glb',
                name: 'Western Peace',
                color: 'white',
                pulseId: 'pulseWest'
            },
            {
                id: 'north-artwork',
                src: 'north-piece.glb',
                name: 'Northern Wisdom',
                color: 'blue',
                pulseId: 'pulseNorth'
            }
        ];

        let currentArtworkIndex = 0;
        let growthCount = 0;
        const grownSculptures = new Set();

        // Convert screen coordinates to 3D world position
        function screenToWorld(screenX, screenY) {
            const camera = document.querySelector('[camera]');
            const canvas = document.querySelector('a-scene').canvas;
            
            // Normalize screen coordinates (-1 to 1)
            const x = (screenX / canvas.clientWidth) * 2 - 1;
            const y = -(screenY / canvas.clientHeight) * 2 + 1;
            
            // Project ray from camera
            const cameraPos = camera.object3D.position;
            const cameraRot = camera.object3D.rotation;
            
            // Calculate ground intersection (Y = -0.5)
            const groundY = -0.5;
            const rayLength = Math.abs((cameraPos.y - groundY) / Math.sin(cameraRot.x || -0.1));
            
            // Calculate world position
            const worldX = cameraPos.x + (x * rayLength * 0.3);
            const worldZ = cameraPos.z - (rayLength * 0.8);
            
            return {
                x: Math.max(-2, Math.min(2, worldX)),
                y: groundY,
                z: Math.max(-3, Math.min(-0.5, worldZ))
            };
        }

        // Meditative tap handler
        document.getElementById('tapSurface').addEventListener('click', function(event) {
            if (currentArtworkIndex >= artworkSequence.length) return;

            const currentArtwork = artworkSequence[currentArtworkIndex];
            const tapPosition = screenToWorld(event.clientX, event.clientY);
            
            // Show colored discovery pulse at tap location
            showColoredPulse(currentArtwork.pulseId, event.clientX, event.clientY);
            
            // Create and grow sculpture at tap location
            createAndGrowSculpture(currentArtwork, tapPosition);
            
            currentArtworkIndex++;
            growthCount++;
            updateProgress();
        });

        function showColoredPulse(pulseId, x, y) {
            const pulse = document.getElementById(pulseId);
            pulse.style.left = x + 'px';
            pulse.style.top = y + 'px';
            pulse.style.display = 'block';
            pulse.style.animation = 'none';
            
            // Restart animation
            pulse.offsetHeight;
            pulse.style.animation = pulse.className.includes('pulse-east') ? 'pulseGreen 2.5s ease-out' :
                                  pulse.className.includes('pulse-south') ? 'pulsePink 2.5s ease-out' :
                                  pulse.className.includes('pulse-west') ? 'pulseWhite 2.5s ease-out' :
                                  'pulseBlue 2.5s ease-out';
            
            setTimeout(() => {
                pulse.style.display = 'none';
            }, 2500);
        }

        function createAndGrowSculpture(artworkConfig, position) {
            const container = document.getElementById('sculpture-container');
            
            // Create sculpture element
            const sculpture = document.createElement('a-gltf-model');
            sculpture.setAttribute('id', artworkConfig.id);
            sculpture.setAttribute('src', artworkConfig.src);
            sculpture.setAttribute('position', `${position.x} ${position.y - 0.3} ${position.z}`);
            sculpture.setAttribute('scale', '0 0 0');
            sculpture.setAttribute('visible', false);
            
            // Add calm growth animation
            sculpture.setAttribute('animation__emerge', 
                'property: position; ' +
                `from: ${position.x} ${position.y - 0.8} ${position.z}; ` +
                `to: ${position.x} ${position.y + 0.1} ${position.z}; ` +
                'dur: 5000; easing: easeOutQuart; startEvents: emerge'
            );
            
            sculpture.setAttribute('animation__grow', 
                'property: scale; from: 0 0 0; to: 1.2 1.2 1.2; ' +
                'dur: 6000; easing: easeOutElastic; startEvents: grow'
            );
            
            sculpture.setAttribute('animation__breathe', 
                `property: position; from: ${position.x} ${position.y + 0.1} ${position.z}; ` +
                `to: ${position.x} ${position.y + 0.15} ${position.z}; ` +
                'dir: alternate; dur: 8000; easing: easeInOutSine; loop: true; startEvents: breathe'
            );
            
            sculpture.setAttribute('animation__gentle-turn', 
                'property: rotation; to: 0 30 0; ' +
                'dur: 60000; easing: easeInOutSine; startEvents: turn'
            );
            
            container.appendChild(sculpture);
            
            // Load and show with meditation timing
            sculpture.addEventListener('model-loaded', function() {
                setTimeout(() => {
                    sculpture.setAttribute('visible', true);
                    sculpture.emit('emerge');
                }, 300);
                
                setTimeout(() => {
                    sculpture.emit('grow');
                }, 800);
                
                setTimeout(() => {
                    sculpture.emit('breathe');
                    sculpture.emit('turn');
                }, 5500);
            });
            
            sculpture.addEventListener('model-error', function() {
                console.log(`Failed to load ${artworkConfig.name}`);
            });
            
            grownSculptures.add(artworkConfig.id);
        }

        function updateProgress() {
            document.getElementById('count').textContent = growthCount;
            
            if (growthCount >= 4) {
                // Meditation complete
                setTimeout(() => {
                    document.getElementById('instructions').style.display = 'none';
                    document.getElementById('tapHint').style.display = 'none';
                    document.getElementById('completionMessage').style.display = 'block';
                }, 3000);
            } else {
                updateMeditativeInstructions();
            }
        }

        function updateMeditativeInstructions() {
            const instructions = document.getElementById('instructions');
            const messages = [
                "Breathe deeply. Touch the ground to grow your garden ðŸŒ±",
                "Feel the earth. Another sculpture awaits your touch ðŸŒ¿",
                "Center yourself. Two more await your presence ðŸŒ¸",
                "Almost complete. One final touch needed ðŸŒº"
            ];
            
            if (growthCount < messages.length) {
                instructions.innerHTML = messages[growthCount];
            }
        }

        // Gentle zoom for meditation
        let lastTouchDistance = 0;
        let isZooming = false;

        document.addEventListener('touchstart', function(e) {
            if (e.touches.length === 2) {
                isZooming = true;
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                lastTouchDistance = Math.sqrt(
                    Math.pow(touch2.clientX - touch1.clientX, 2) +
                    Math.pow(touch2.clientY - touch1.clientY, 2)
                );
                e.preventDefault();
            }
        });

        document.addEventListener('touchmove', function(e) {
            if (e.touches.length === 2 && isZooming) {
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const currentDistance = Math.sqrt(
                    Math.pow(touch2.clientX - touch1.clientX, 2) +
                    Math.pow(touch2.clientY - touch1.clientY, 2)
                );
                
                const scale = currentDistance / lastTouchDistance;
                gentleZoomAll(scale);
                lastTouchDistance = currentDistance;
                e.preventDefault();
            }
        });

        document.addEventListener('touchend', function(e) {
            if (e.touches.length < 2) {
                isZooming = false;
            }
        });

        function gentleZoomAll(scaleFactor) {
            grownSculptures.forEach(sculptureId => {
                const sculpture = document.getElementById(sculptureId);
                if (sculpture && sculpture.getAttribute('visible')) {
                    const currentScale = sculpture.getAttribute('scale');
                    const newScale = {
                        x: Math.max(0.5, Math.min(2.0, currentScale.x * scaleFactor)),
                        y: Math.max(0.5, Math.min(2.0, currentScale.y * scaleFactor)),
                        z: Math.max(0.5, Math.min(2.0, currentScale.z * scaleFactor))
                    };
                    sculpture.setAttribute('scale', newScale);
                }
            });
        }

        // Reset for new meditation session
        function resetMeditation() {
            const container = document.getElementById('sculpture-container');
            container.innerHTML = '';
            
            currentArtworkIndex = 0;
            growthCount = 0;
            grownSculptures.clear();
            
            document.getElementById('count').textContent = '0';
            document.getElementById('instructions').style.display = 'block';
            document.getElementById('tapHint').style.display = 'block';
            document.getElementById('instructions').innerHTML = 'Breathe deeply. Touch the ground to grow your garden ðŸŒ±';
            document.getElementById('completionMessage').style.display = 'none';
        }

        // Gentle shake to reset
        let shakeTimeout;
        window.addEventListener('devicemotion', function(event) {
            if (event.acceleration && 
                (Math.abs(event.acceleration.x) > 12 || 
                 Math.abs(event.acceleration.y) > 12 || 
                 Math.abs(event.acceleration.z) > 12)) {
                
                clearTimeout(shakeTimeout);
                shakeTimeout = setTimeout(resetMeditation, 1000);
            }
        });

        // Prevent context menu
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

        // Hide tap hint after initial guidance
        setTimeout(() => {
            const hint = document.getElementById('tapHint');
            if (hint && growthCount === 0) {
                hint.style.opacity = '0.3';
                setTimeout(() => {
                    hint.style.display = 'none';
                }, 3000);
            }
        }, 8000);
    </script>
</body>
</html>
